<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-02-15">

<title>Observational Studies and Causal Inference – Medical Maths</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../medmaths-custom-styling.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Medical Maths</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Observational Studies and Causal Inference</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 15, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Disclaimer
</div>
</div>
<div class="callout-body-container callout-body">
<p>This blog post was written solely for informational and educational purposes, and does not constitute medical advice. If you have any health concerns, please consult a qualified medical professional.</p>
</div>
</div>
<p>Randomised Controlled Trials (RCTs) are widely recognised as the gold standard of study designs, but they are not always possible to perform. For example, it would have been neither ethical nor feasible for Richard Doll and Austin Bradford Hill to randomly assign a group of volunteers to a smoking and non-smoking group in order to show that cigarettes cause lung cancer. However, they were still able to establish a link between smoking and the disease, using first a case-control study and then a prospective cohort study<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>These are both types of observational study<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, an alternative to RCTs that can be very useful – as in the case of smoking and lung cancer. Unfortunately, the fact the participants are not randomised to different groups in observational studies can make their results particularly difficult to interpret. In this article, I will discuss how diagrams representing causal relationships can help us to spot potential sources of bias in these kinds of studies.</p>
<section id="causal-inference" class="level2">
<h2 class="anchored" data-anchor-id="causal-inference">Causal Inference</h2>
<p>Causal relationships are notoriously difficult to distinguish from mere statistical associations, as summed up in the famous saying “correlation does not imply causation”. A humorous example of this can be found in an educational statistics paper in which the author investigates the fairy tale that storks deliver babies by analysing 1980s estimates of stork populations and birth rates in seventeen different European countries<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div style="overflow-x:auto;">
  
<table class="table table-bordered table-sm" data-quarto-postprocess="true">
<caption>Estimates of European Stork Populations and Birth Rates in the 1980s</caption>
<tbody>
<tr class="odd">
<td rowspan="2" style="background-color: #e4f8ff"></td>
<td colspan="17" style="text-align: left; vertical-align: middle; background-color: #006a90; color: white; padding-left: 0.75rem; padding-right: 0.75rem;">Country</td>
</tr>
<tr class="even">
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Albania</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Austria</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Belgium</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Bulgaria</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Denmark</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">France</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Germany</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Greece</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Holland</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Hungary</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Italy</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Poland</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Portugal</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Romania</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Spain</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Switzerland</td>
<td style="text-align: left; vertical-align: middle; padding-left: 0.75rem; padding-right: 0.75rem; background-color: #009ed8; color: white;">Turkey</td>
</tr>
<tr class="odd">
<td style="text-align: left; vertical-align: middle; background-color: #006a90; color: white; padding-left: 0.75rem; padding-right: 0.75rem;">Stork Pairs</td>
<td style="text-align: center; vertical-align: middle;">100</td>
<td style="text-align: center; vertical-align: middle;">300</td>
<td style="text-align: center; vertical-align: middle;">1</td>
<td style="text-align: center; vertical-align: middle;">5000</td>
<td style="text-align: center; vertical-align: middle;">9</td>
<td style="text-align: center; vertical-align: middle;">140</td>
<td style="text-align: center; vertical-align: middle;">3300</td>
<td style="text-align: center; vertical-align: middle;">2500</td>
<td style="text-align: center; vertical-align: middle;">4</td>
<td style="text-align: center; vertical-align: middle;">5000</td>
<td style="text-align: center; vertical-align: middle;">5</td>
<td style="text-align: center; vertical-align: middle;">30,000</td>
<td style="text-align: center; vertical-align: middle;">1500</td>
<td style="text-align: center; vertical-align: middle;">5000</td>
<td style="text-align: center; vertical-align: middle;">8000</td>
<td style="text-align: center; vertical-align: middle;">150</td>
<td style="text-align: center; vertical-align: middle;">25,000</td>
</tr>
<tr class="even">
<td style="text-align: left; vertical-align: middle; background-color: #006a90; color: white; padding-left: 0.75rem; padding-right: 0.75rem;">Yearly Births</td>
<td style="text-align: center; vertical-align: middle;">83,000</td>
<td style="text-align: center; vertical-align: middle;">87,000</td>
<td style="text-align: center; vertical-align: middle;">118,000</td>
<td style="text-align: center; vertical-align: middle;">117,000</td>
<td style="text-align: center; vertical-align: middle;">59,000</td>
<td style="text-align: center; vertical-align: middle;">774,000</td>
<td style="text-align: center; vertical-align: middle;">901,000</td>
<td style="text-align: center; vertical-align: middle;">106,000</td>
<td style="text-align: center; vertical-align: middle;">188,000</td>
<td style="text-align: center; vertical-align: middle;">124,000</td>
<td style="text-align: center; vertical-align: middle;">551,000</td>
<td style="text-align: center; vertical-align: middle;">610,000</td>
<td style="text-align: center; vertical-align: middle;">120,000</td>
<td style="text-align: center; vertical-align: middle;">367,000</td>
<td style="text-align: center; vertical-align: middle;">439,000</td>
<td style="text-align: center; vertical-align: middle;">82,000</td>
<td style="text-align: center; vertical-align: middle;">1,576,000</td>
</tr>
</tbody>
</table>

</div>
<p>We can plot these data and observe a linear relationship between stork populations and birth rates, with a correlation coefficient of 0.62 to two significant figures.</p>
<div class="cell">
<details class="code-fold">
<summary>Plotting the Data and Calculating the Correlation Coefficient in R</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>stork_pairs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">300</span>, <span class="dv">1</span>, <span class="dv">5000</span>, <span class="dv">9</span>, <span class="dv">140</span>, <span class="dv">3300</span>, <span class="dv">2500</span>, <span class="dv">4</span>, <span class="dv">5000</span>, <span class="dv">5</span>, <span class="dv">30000</span>, <span class="dv">1500</span>, <span class="dv">5000</span>, <span class="dv">8000</span>, <span class="dv">150</span>, <span class="dv">25000</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>yearly_births <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">83000</span>, <span class="dv">87000</span>, <span class="dv">118000</span>, <span class="dv">117000</span>, <span class="dv">59000</span>, <span class="dv">774000</span>, <span class="dv">901000</span>, <span class="dv">106000</span>, <span class="dv">188000</span>, <span class="dv">124000</span>, <span class="dv">551000</span>, <span class="dv">610000</span>, <span class="dv">120000</span>, <span class="dv">367000</span>, <span class="dv">439000</span>, <span class="dv">82000</span>, <span class="dv">1576000</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>correlation <span class="ot">&lt;-</span> <span class="fu">cor</span>(stork_pairs, yearly_births) <span class="co"># calculating the pearson correlation coefficient</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="at">bottom=</span><span class="fl">4.2</span>, <span class="at">left=</span><span class="fl">5.1</span>, <span class="at">top=</span><span class="fl">1.8</span>, <span class="at">right=</span><span class="fl">0.9</span>), <span class="at">family=</span><span class="st">"Roboto Slab"</span>) <span class="co"># setting the plot options</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stork_pairs, yearly_births, <span class="co"># plotting the data points</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Stork Pairs"</span>, <span class="at">ylab=</span><span class="st">"Yearly Births"</span>, </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch=</span><span class="dv">4</span>, <span class="at">cex=</span><span class="fl">1.8</span>, <span class="at">col=</span><span class="st">"#009ed8"</span>, <span class="at">lwd=</span><span class="fl">4.8</span>, <span class="at">cex.lab=</span><span class="fl">1.5</span>, <span class="at">cex.axis=</span><span class="fl">1.5</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(yearly_births <span class="sc">~</span> stork_pairs), <span class="co"># adding the line of best fit</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">"#ffc000"</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">lwd =</span> <span class="fl">4.2</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend=</span><span class="fu">paste0</span>(<span class="st">"Line of Best Fit  (r="</span>, <span class="fu">round</span>(correlation, <span class="dv">2</span>), <span class="st">")"</span>), </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="st">"#ffc000"</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="fl">4.2</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/storks-and-babies-graph-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>Moreover, performing a significance test for correlation with the null hypothesis that there is no relationship between stork populations and birth rates gives us a p-value of less than 0.05, a common threshold for a result to be considered statistically significant<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Testing the Null Hypothesis in R</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>significance_test <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(stork_pairs, yearly_births)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>p_val <span class="ot">&lt;-</span> significance_test<span class="sc">$</span>p.value</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"p-value:"</span>, p_val), <span class="at">quote=</span><span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] p-value: 0.00789786078801809</code></pre>
</div>
</div>
<p>Clearly, more storks do not cause more babies to be born. But the non-causality of statistical associations might not always be so obvious. To deal with the challenges of understanding causes and effects, a new branch of statistics known as ‘causal inference’ has emerged over the past few decades<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
<p>This type of statistics often involves the use of directed acyclic graphs – ‘DAGs’ for short – to model the relationships between variables. Let’s explore the essential features of these diagrams.</p>
<section id="directed-acyclic-graphs" class="level3">
<h3 class="anchored" data-anchor-id="directed-acyclic-graphs">Directed Acyclic Graphs</h3>
<p>In discrete mathematics, a <strong>graph</strong> is a structure made up of vertices linked by edges. A path between two vertices is a sequence of edges linking them together<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<p><img src="example-graph.png" class="img-fluid"></p>
<p>For example, in the above graph, there is a path between A and C along the the sequence of edges between vertices A, B, D, E, and C.</p>
<p><strong>Directed</strong> graphs are a particular type of graph in which all the edges are arrows. In these types of graph a vertex can be an descendant or ancestor of another vertex if there is a path of arrows all pointing in the same direction between them; the descendant lies at the arrowhead and ancestors lies at the tail. If this path is only one edge long, the ancestor can be called the descendant’s parent and the descendant can be called the parent’s child<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<p><img src="example-dag.png" class="img-fluid"></p>
<p>Here, B is a parent (and thus also an ancestor) of C and D, a child (and descendant) of A, and and ancestor of E.</p>
<p>Directed graphs are ideal for causal inference, because we can use vertices to represent the variables and edges to represent the causal relationships between them, with parents having a direct effect on their children. For example, a simplified DAG showing the effects of different factors on a person’s chance of developing lung cancer might show the variables ‘Genetics’, ‘Environmental Factors’, and ‘Smoking’ all to be parents of the variable ‘Lung Cancer Risk’.</p>
<p><img src="smoking-dag.png" class="img-fluid"></p>
<p>An <strong>acyclic</strong> graph is simply one that contains no cycles (a cycle is a directed path leading from a variable back to itself), so when we use a DAG to model causal relationships a variable cannot cause itself.</p>
<p>An example of a DAG which might explain the correlation between the stork populations and birth rates of European countries could introduce extra variables, such as land area and human population size.</p>
<p><img src="storks-dag.png" class="img-fluid"></p>
<p>This DAG could account for the association between the ‘Stork Population’ and ‘Birth Rate’ variables without requiring there to be a causal relationship between them; their correlation can be explained by the fact that ‘Land Area’ is both a parent of ‘Stork Population’ and an ancestor of ‘Birth Rate’.</p>
<p>There are several structures that commonly appear appear in DAGs representing observational studies. In the rest of this article I want to focus on two of the most important – <strong>confounders</strong> and <strong>colliders</strong> – and explore how both of them can help to explain misleading results in medical research.</p>
</section>
</section>
<section id="confounders" class="level2">
<h2 class="anchored" data-anchor-id="confounders">Confounders</h2>
<p>When we are investigating the effect of a variable X on another variable Y using an observational study, one of the most common ways we can be misled is by <strong>confounding</strong><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. This occurs when a third variable has an effect on both X and Y, which can lead to them being correlated even if there is not in fact a causal relationship between them. For instance, we could say that land area is a confounder when we are investigating the relationship between stork populations and birth rates, because an increase in land area leads to an increase in both variables. In a DAG, we can define a confounder to be a variable on a path between X and Y which is an ancestor of both of them<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>.</p>
<p><img src="example-confounder.png" class="img-fluid"></p>
<p>In the most extreme cases, confounding can actually mean that the true effect of X on Y is reversed, in a phenomenon known as Simpson’s paradox<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>. <a href="https://robertheaton.com/">Robert Heaton</a> gives an helpful illustration of this in his blog post <a href="https://robertheaton.com/2019/02/24/making-peace-with-simpsons-paradox/">‘Making peace with Simpson’s Paradox’</a>. He asks us to imagine a hypothetical illness with a specific drug treatment that causes faster recovery in higher dosages. This would seem quite straightforward to prove by collecting data on the amount of treatment different patients were given and the time it took them to recover. Then, however, he complicates the scenario by introducing a third variable – age. If older people tend to recover more slowly, and also tend to require higher dosages of the treatment drug to recover at all, an observational study that does not control for age may actually end up showing a negative correlation between drug dosage and recovery speed.</p>
<div class="cell">
<details class="code-fold">
<summary>Simulating and Plotting Data to Illustrate Robert Heaton’s Example of Simpson’s Paradox in R</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">31415</span>) </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>group_1_dosages <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>group_2_dosages <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">21</span><span class="sc">:</span><span class="dv">40</span>, <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>group_3_dosages <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">41</span><span class="sc">:</span><span class="dv">60</span>, <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>all_dosages <span class="ot">&lt;-</span> <span class="fu">c</span>(group_1_dosages, group_2_dosages, group_3_dosages)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>group_1_recovery_speeds <span class="ot">&lt;-</span> <span class="fl">1.2</span> <span class="sc">*</span> group_1_dosages <span class="sc">+</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">20</span>,<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>group_2_recovery_speeds <span class="ot">&lt;-</span> <span class="fl">1.2</span> <span class="sc">*</span> group_2_dosages <span class="sc">+</span> <span class="dv">50</span> <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">20</span>,<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>group_3_recovery_speeds <span class="ot">&lt;-</span> <span class="fl">1.2</span> <span class="sc">*</span> group_3_dosages <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">20</span>,<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>all_recovery_speeds <span class="ot">&lt;-</span> <span class="fu">c</span>(group_1_recovery_speeds, group_2_recovery_speeds, group_3_recovery_speeds)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="at">bottom=</span><span class="fl">2.4</span>, <span class="at">left=</span><span class="dv">3</span>, <span class="at">top=</span><span class="fl">2.4</span>, <span class="at">right=</span><span class="fl">0.9</span>), <span class="at">family=</span><span class="st">"Roboto Slab"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(group_1_dosages, group_1_recovery_speeds, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">72</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">36</span>,<span class="dv">120</span>), <span class="at">bty=</span><span class="st">"n"</span>, <span class="at">xaxt=</span><span class="st">"n"</span>, <span class="at">yaxt=</span><span class="st">"n"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">2.4</span>,  <span class="at">col=</span><span class="st">"#009ed8"</span>) </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(group_2_dosages, group_2_recovery_speeds, <span class="at">pch=</span><span class="dv">17</span>, <span class="at">cex=</span><span class="fl">2.4</span>,  <span class="at">col=</span><span class="st">"#009ed8"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(group_3_dosages, group_3_recovery_speeds, <span class="at">pch=</span><span class="dv">18</span>, <span class="at">cex=</span><span class="fl">2.4</span>,  <span class="at">col=</span><span class="st">"#009ed8"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(<span class="at">x0=</span><span class="dv">0</span>, <span class="at">y0=</span><span class="dv">39</span>, <span class="at">x1=</span><span class="dv">72</span>, <span class="at">y1=</span><span class="dv">39</span>, <span class="at">length=</span><span class="fl">0.15</span>, <span class="at">code=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">"#808080"</span>) </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(<span class="at">x0=</span><span class="dv">0</span>, <span class="at">y0=</span><span class="dv">39</span>, <span class="at">x1=</span><span class="dv">0</span>, <span class="at">y1=</span><span class="dv">120</span>, <span class="at">length=</span><span class="fl">0.15</span>, <span class="at">code=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">"#808080"</span>) </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"Drug Dosage"</span>, <span class="at">side=</span><span class="dv">1</span>, <span class="at">line=</span><span class="dv">1</span>, <span class="at">cex=</span><span class="fl">1.8</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"Recovery Speed"</span>, <span class="at">side=</span><span class="dv">2</span>, <span class="at">line=</span><span class="dv">0</span>, <span class="at">cex=</span><span class="fl">1.8</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(group_1_recovery_speeds <span class="sc">~</span> group_1_dosages), <span class="at">col=</span><span class="st">"#006a90"</span>, <span class="at">lwd=</span><span class="fl">4.8</span>, <span class="at">lty=</span><span class="dv">2</span>) </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(group_2_recovery_speeds <span class="sc">~</span> group_2_dosages), <span class="at">col=</span><span class="st">"#006a90"</span>, <span class="at">lwd=</span><span class="fl">4.8</span>, <span class="at">lty=</span><span class="dv">2</span>) </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(group_3_recovery_speeds <span class="sc">~</span> group_3_dosages), <span class="at">col=</span><span class="st">"#006a90"</span>, <span class="at">lwd=</span><span class="fl">4.8</span>, <span class="at">lty=</span><span class="dv">2</span>) </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(all_recovery_speeds <span class="sc">~</span> all_dosages), <span class="at">col=</span><span class="st">"#ffc000"</span>, <span class="at">lwd=</span><span class="fl">4.8</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">54</span>, <span class="at">y=</span><span class="dv">120</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"20–39 Year Olds "</span>, <span class="st">"40–59 Year Olds "</span>, <span class="st">"60–79 Year Olds "</span>), <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>), <span class="at">col=</span><span class="st">"#009ed8"</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">3</span>, <span class="at">y=</span><span class="dv">54</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Overall Line of Best Fit "</span>, <span class="st">"Age Group Lines of Best Fit "</span>), <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"#ffc000"</span>,<span class="st">"#006a90"</span>), <span class="at">lwd=</span><span class="fl">4.2</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/robert-heaton-example-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>In the simulated data plotted above, a higher dosage of the treatment drug corresponds with a faster recovery speed within each age category. However, when we combine data from all the age categories we find a negative correlation between drug dosage and recovery speed.</p>
<div class="cell">
<details class="code-fold">
<summary>Finding the Correlation Coefficient in R</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>correlation <span class="ot">&lt;-</span> <span class="fu">cor</span>(all_dosages, all_recovery_speeds)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Pearson Correlation Coefficient:"</span>, correlation), <span class="at">quote=</span><span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] Pearson Correlation Coefficient: -0.745394350451033</code></pre>
</div>
</div>
<p>When we draw the DAG for this example, we can see that the variable ‘Age’ is acting as a counfounder, obscuring the true causal relationship between the ‘Drug Dosage’ and ‘Recovery Speed’ variables.</p>
<p><img src="robert-heaton-example-dag.png" class="img-fluid"></p>
<p>Simpson’s paradox has been observed several times in the medical literature, perhaps most famously in a 1986 observational study by a group of urologists on the effectiveness of different types of procedure for the removal of kidney stones<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>. Wisely, the researchers recognised that stone size might be a confounding factor, so they split their data according to whether the original stone was less than two centimetres in diameter or not.</p>
<div style="overflow-x:auto;">
  
<table class="table table-bordered table-sm" data-quarto-postprocess="true">
<caption>Observed Success Rate of Kidney Stone Removal Procedures</caption>
<tbody>
<tr class="odd">
<td colspan="2" rowspan="2" style="background-color: #e4f8ff"></td>
<td colspan="2" style="text-align: center; vertical-align: middle; background-color: #006a90; color: white;">Success Rate</td>
</tr>
<tr class="even">
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white; width: 36%;">Open Surgery</td>
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white; width: 36%;">Percutaneous Nephrolithotomy</td>
</tr>
<tr class="odd">
<td rowspan="3" style="text-align: center; vertical-align: middle; background-color: #006a90; color: white;">Stone Size</td>
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white;">Small</td>
<td style="text-align: center; vertical-align: middle;"><strong>≈ 93%</strong> <span class="math inline">\(\left( \frac{81}{87} \right)\)</span></td>
<td style="text-align: center; vertical-align: middle;">≈ 87% <span class="math inline">\(\left( \frac{234}{270} \right)\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white;">Large</td>
<td style="text-align: center; vertical-align: middle;"><strong>≈ 73%</strong> <span class="math inline">\(\left( \frac{192}{263} \right)\)</span></td>
<td style="text-align: center; vertical-align: middle;">≈ 69% <span class="math inline">\(\left( \frac{55}{80} \right)\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white;">Both</td>
<td style="text-align: center; vertical-align: middle;">≈ 78% <span class="math inline">\(\left( \frac{273}{350} \right)\)</span></td>
<td style="text-align: center; vertical-align: middle;"><strong>≈ 83%</strong> <span class="math inline">\(\left( \frac{289}{350} \right)\)</span></td>
</tr>
</tbody>
</table>

</div>
<p>The urologists found that open surgery had been more successful than percutaneous nephrolithotomy in both small and large stones. But if they had not stratified their data by stone size, they would have obtained a higher overall success rate for percutaneous nephrolithotomy than for open surgery. The reason for this was that patients with small stones were more likely to be treated with percutaneous nephrolithotomy than patients with larger stones, and these were also the patients most likely to have a good result regardless of the procedure they underwent. So stone size influenced both the choice of treatment and the treatment outcome, and thus acted as a counfounder.</p>
<p><img src="kidney-stones-dag.png" class="img-fluid"></p>
<p>The size of a patient’s stone might have influenced their probability of having one treatment over another for any number of reasons. For instance, perhaps patients with smaller stones were more inclined to be concerned about the side effects of open surgery, or perhaps there was a longer waiting list for percutaneous nephrolithotomy that patients with larger stones tend to be less willing to tolerate. (These are just examples of possible explanations, not necessarily the true reasons that the size of kidney stones affected doctors and patients’ choice of treatment in the 1986 study.)</p>
</section>
<section id="colliders" class="level2">
<h2 class="anchored" data-anchor-id="colliders">Colliders</h2>
<p>Another issue that can arise in observational studies is <strong>collider bias</strong>. When we are investigating the effect of X on Y, a collider is a variable lying on a path between X and Y where two causal arrows meet, meaning the collider has more than one parent.</p>
<p><img src="example-collider.png" class="img-fluid"> In observational medical studies, it is not uncommon that the variables we are investigating, X and Y, both have a causal effect on the probability that a patient is included in the study. In these cases, selection into the study is itself a collider variable.</p>
<p>To understand how collider bias can cause unrelated variables to appear to have a correlation, let’s imagine a hypothetical virus called ‘colliditis’. We’ll supose that the severity of disease experienced by people who catch colliditis is unrelated to the number of cigarettes they smoke in a day. For simplicity, we can assume that the average number of cigarettes of smoked a day and the severity of disease are uniformly distributed in the population of people who have caught colliditis. So if we plotted a random sample of one thousand people from the population of people with the viral infection, it would look like this.</p>
<div class="cell">
<details class="code-fold">
<summary>Plotting the Relationship Between Disease Severity and Average Number of Cigarettes Smoked in a Day in a Simulated Sample of People Infected With Colliditis in R</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">31415</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>infected_sample <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>n, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co"># we initialise an empty matrix to store the data for each person</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  severity <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min=</span><span class="dv">0</span>, <span class="at">max=</span><span class="dv">20</span>) <span class="co"># we assign each person in the sample a random severity score between 0 and 20</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  cigarettes <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">20</span>) <span class="co"># we assign each person in the sample a random average number of cigarettes smoked per day between 0 and 20</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  infected_sample[i,<span class="dv">1</span>] <span class="ot">&lt;-</span> severity</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  infected_sample[i,<span class="dv">2</span>] <span class="ot">&lt;-</span> cigarettes</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="at">bottom=</span><span class="fl">4.2</span>, <span class="at">left=</span><span class="fl">5.1</span>, <span class="at">top=</span><span class="fl">1.8</span>, <span class="at">right=</span><span class="fl">0.9</span>), <span class="at">family=</span><span class="st">"Roboto Slab"</span>) </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(infected_sample[,<span class="dv">1</span>], infected_sample[,<span class="dv">2</span>], <span class="at">pch=</span><span class="dv">4</span>, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">lwd=</span><span class="fl">2.4</span>, <span class="at">col=</span><span class="st">"#808080"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Colliditis Severity Score"</span>, <span class="at">ylab=</span><span class="st">"Average Number of Cigarettes Smoked in a Day"</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.lab=</span><span class="fl">1.5</span>, <span class="at">cex.axis=</span><span class="fl">1.5</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(infected_sample[,<span class="dv">1</span>] <span class="sc">~</span> infected_sample[,<span class="dv">2</span>]), <span class="at">lwd=</span><span class="fl">4.8</span>, <span class="at">col=</span><span class="st">"#009ed8"</span>,) <span class="co"># we plot the line of best fit</span></span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/colliditis-infected-sample-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>Now suppose that out of this sample, 90% the people with a colliditis severity score ≥15 are in hospital, and of those with a colliditis severity score &lt;15, those who smoke ≥10 cigarettes a day on average have a 60% chance of being in hospital, compared to a 10% chance for those who smoke &lt;10 cigarettes a day on average. If we plot cigarettes vs colliditis severity of only those in our sample who are hospitalised, we see an interesting result.</p>
<div class="cell">
<details class="code-fold">
<summary>Plotting the Relationship Between Disease Severity and Average Number of Cigarettes Smoked in a Day in a Simulated Sample of Hospitalised People Infected With Colliditis in R</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">31415</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>hospital_infected_sample <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">2</span><span class="sc">*</span>n), <span class="at">nrow=</span>n, <span class="at">ncol=</span><span class="dv">2</span>) </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  dice_roll <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min=</span><span class="dv">0</span>, <span class="at">max=</span><span class="dv">1</span>) <span class="co"># we generate random number between 0 and 1</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  person_i <span class="ot">&lt;-</span> infected_sample[i,]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(person_i[<span class="dv">1</span>] <span class="sc">&gt;=</span> <span class="dv">15</span> <span class="sc">&amp;&amp;</span> dice_roll <span class="sc">&lt;=</span> <span class="fl">0.9</span>) { <span class="co"># these people have a 90% chance of being in hospital</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    hospital_infected_sample[i,] <span class="ot">&lt;-</span> person_i</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(person_i[<span class="dv">2</span>] <span class="sc">&gt;=</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> dice_roll <span class="sc">&lt;=</span> <span class="fl">0.6</span>) { <span class="co"># these people have a 60% chance of being in hospital</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    hospital_infected_sample[i,] <span class="ot">&lt;-</span> person_i</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(person_i[<span class="dv">2</span>] <span class="sc">&lt;</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> dice_roll <span class="sc">&lt;=</span> <span class="fl">0.1</span>) { <span class="co"># others have a 10% chance of being in hospital</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    hospital_infected_sample[i,] <span class="ot">&lt;-</span> person_i</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we remove the people not in hospital from our sample:</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>hospital_infected_sample <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(hospital_infected_sample)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># And plot the result:</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="at">bottom=</span><span class="fl">4.2</span>, <span class="at">left=</span><span class="fl">5.1</span>, <span class="at">top=</span><span class="fl">1.8</span>, <span class="at">right=</span><span class="fl">0.9</span>), <span class="at">family=</span><span class="st">"Roboto Slab"</span>) </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hospital_infected_sample[,<span class="dv">1</span>], hospital_infected_sample[,<span class="dv">2</span>], <span class="at">pch=</span><span class="dv">4</span>, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">lwd=</span><span class="fl">2.4</span>, <span class="at">col=</span><span class="st">"#808080"</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Colliditis Severity Score"</span>, <span class="at">ylab=</span><span class="st">"Average Number of Cigarettes Smoked in a Day"</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.lab=</span><span class="fl">1.5</span>, <span class="at">cex.axis=</span><span class="fl">1.5</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(hospital_infected_sample[,<span class="dv">1</span>] <span class="sc">~</span> hospital_infected_sample[,<span class="dv">2</span>]), <span class="at">lwd=</span><span class="fl">4.8</span>, <span class="at">col=</span><span class="st">"#009ed8"</span>,) <span class="co"># we plot the line of best fit</span></span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/colliditis-hospitalised-sample-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>If we took the hospitalised population as representative of the general population we would find that there is a negative relationship between average number of cigarettes smoked in a day and severity of colliditis. But we would be failing to account for the fact that having a severe case of colliditis, and smoking a large number of cigarettes per day are both factors that make you more likely to be in hospital. So if you are in hospital with a low colliditis score, you are more likely to smoke a lot of cigarettes than if you are in hospital with a high colliditis score, since there must be some other reason for your hospitalisation than colliditis, and this reason may be smoking.</p>
<p>The DAG for this example would show that ‘Hospitalisation’ is a collider, and that there is no true causal relationship between the variables ‘Smoking’ and ‘Severity’.</p>
<p><img src="colliditis-dag.png" class="img-fluid"></p>
<p>For an example of collider bias in the medical literature, let’s turn to a case-control study of hospital patients with and without pancreatic cancer published in 1981<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>, which found a strong association between patients’ coffee consumption and their likelihood of having developed pancreatic cancer.</p>
<div style="overflow-x:auto;">
  
<table class="table table-bordered table-sm" data-quarto-postprocess="true">
<caption>Observed Coffee Consumption in Patients With and Without Pancreatic Cancer</caption>
<tbody>
<tr class="odd">
<td colspan="2" rowspan="2" style="background-color: #e4f8ff"></td>
<td colspan="3" style="text-align: center; vertical-align: middle; background-color: #006a90; color: white;">Coffee Consumption</td>
</tr>
<tr class="even">
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white;">Pecentage That Drink 0 Cups Per Day</td>
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: #cccccc;">Pecentage That Drink 1 or 2 Cups Per Day</td>
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white;">Pecentage That Drink 3+ Cups Per Day</td>
</tr>
<tr class="odd">
<td rowspan="2" style="text-align: center; vertical-align: middle; background-color: #006a90; color: white;">Diagnosis</td>
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white;">Pancreatic Cancer</td>
<td style="text-align: center; vertical-align: middle;">≈ 5% <span class="math inline">\(\left( \frac{20}{367} \right)\)</span></td>
<td style="text-align: center; vertical-align: middle; color: #808080;">≈ 42% <span class="math inline">\(\left( \frac{153}{367} \right)\)</span></td>
<td style="text-align: center; vertical-align: middle;"><strong>≈ 53%</strong> <span class="math inline">\(\left( \frac{194}{367} \right)\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center; vertical-align: middle; background-color: #009ed8; color: white;">Not Pacratic Cancer</td>
<td style="text-align: center; vertical-align: middle;"><strong>≈ 14%</strong> <span class="math inline">\(\left( \frac{88}{643} \right)\)</span></td>
<td style="text-align: center; vertical-align: middle; color: #808080;">≈ 42% <span class="math inline">\(\left( \frac{271}{643} \right)\)</span></td>
<td style="text-align: center; vertical-align: middle;">≈ 44% <span class="math inline">\(\left( \frac{284}{643} \right)\)</span></td>
</tr>
</tbody>
</table>

</div>
<p>In the decades since this study was published, several large prospective cohort studies have found no significant relationship between coffee consumption and pancreatic cancer risk<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> <a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> <a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a>, suggesting that the original study may have had a flaw in its design. What could it have been?</p>
<p>In his seminal epidemiology textbook<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a>, Leon Gordis points out the control group for this study – patients without pancreatic cancer – was chosen in an unusual way. When a patient who did have pancreatic cancer agreed to answer a survey about their dietary habits, control patients were selected by asking the doctor responsible for their care to identify other patients of theirs without the condition. Since these doctors were often gastroenterologists, patients with gastrointestinal disorders were over-represented in the control group. These patients tended to drink less coffee than the average member of the population, either because it exacerbated their symptoms or because they had been advised to cut down their intake by their doctors.</p>
<p><img src="pancreatic-cancer-dag.png" class="img-fluid"></p>
<p>As a result of the atypical coffee consumption in the control group, the results of this observational study are hard to interpret. This is because even if it was the case that there was no causal relationship between coffee consumption and pancreatic cancer, we would still expect to see an association between them due to the fact that people with GI disorders were more likely to be chosen as controls than other patients. We can show this in a DAG in which ‘Selection into Study’ is a collider.</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further Reading</h2>
<ul>
<li><a href=""><strong>An introduction to Causal inference</strong> – a blog post by Fabian Dablander</a></li>
<li><a href="https://amol-kulkarni.com/project/kidney_stones_simpson_paradox/"><strong>Kidney Stones &amp; Simpson’s Paradox</strong> – a blog post by Amol Kulkarni</a></li>
</ul>


</section>


<div id="quarto-appendix"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">References</h2>

<ol>
<li id="fn1"><p>Jonathan Wood, <a href="https://www.ox.ac.uk/news/science-blog/life-revolutionary">“Life of a revolutionary,”</a> OxSciBlog, November 11, 2009.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><a href="https://www.cebm.ox.ac.uk/resources/ebm-tools/study-designs">“Study designs,”</a> Centre for Evidence-Based Medicine, May 29, 2020.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Robert Matthews, <a href="https://doi.org/10.1111/1467-9639.00013">“Storks Deliver Babies (p=0.008),”</a> <em>Teaching Statistics</em> 22, no. 2 (June 2000): 36–38.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Martin Bland, <em>An Introduction to Medical Statistics.</em> 4th ed.&nbsp;Oxford: Oxford University Press, 2015.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Judea Pearl and Dana Mackenzie, <em>The Book of Why: The New Science of Cause and Effects.</em> London: Penguin Books, 2019.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Sander Greenland, Judea Pearl, and James Robins, <a href="https://doi.org/10.1097%2F00001648-199901000-00008">“Causal Diagrams for Epidemiologic Research,”</a> <em>Epidemiology</em> 10, no. 1 (January 1999): 37–48.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Judea Pearl, Madelyn Glymour, and Nicholas Jewell, <em>Causal Inference in Statistics: A Primer.</em> New York: Wiley, 2016.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>Jeffrey Aronson, Clare Bankhead, and David Nunan, <a href="https://catalogofbias.org/biases/confounding/">“Confounding,”</a> Catalogue of Bias, 2018.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Ricardo Silva, <a href="https://mlg.eng.cam.ac.uk/zoubin/tutorials06.html">“Causality,”</a> (lecture, Advanced Tutorial Lecture Series on Machine Learning, Cambridge, November 9, 2006).<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>Steven Julious and Mark Mullee, <a href="https://doi.org/10.1136%2Fbmj.309.6967.1480">“Confounding and Simpson’s Paradox,”</a> <em>BMJ</em> 309, no. 6968 (December 1994): 1480–1481.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>Clive Charig et al., <a href="https://doi.org/10.1136%2Fbmj.292.6524.879">“Comparison of treatment of renal calculi by open surgery, percutaneous nephrolithotomy, and extracorporeal shockwave lithotripsy,”</a> <em>British Medical Journal (Clinical Research Edition)</em> 292, no. 6524 (March 1986): 879–882.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>Brian MacMahon et al., <a href="https://doi.org/10.1056/NEJM198103123041102">“Coffee and cancer of the pancreas,”</a> <em>The New England Journal of Medicine</em> 304, no. 11 (March 1981): 630–633.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>Simak Bidel et al., <a href="https://doi.org/10.1002/ijc.27773">“Coffee consumption and risk of gastric and pancreatic cancer – A prospective cohort study,”</a> 312, no.7 (April 2012): 1651–1659.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>Kristin Guertin et al., <a href="https://doi.org/10.1038/bjc.2015.235">“A prospective study of coffee intake and pancreatic cancer: results from the NIH-AARP Diet and Health Study,”</a> 113, no. 7 (September 2015): 1081–1085.<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>Charlie Zhou et al., <a href="https://doi.org/10.1002/ijc.31994">“Coffee and pancreatic cancer risk among never-smokers in the UK prospective Million Women Study,”</a> 145 no. 6 (September 2019); 1484–1492.<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>Leon Gordis, <em>Epidemiology.</em> 4th ed.&nbsp;Philadelphia: Saunders, 2008.<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>